<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>éŠæˆ²æ–¹ç¨‹å¼ Game Equation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'wuxia-bg': '#180a0a',       // æ·±ç´…é»‘èƒŒæ™¯
              'wuxia-card': '#2b1212',     // å¡ç‰‡æ·±æœ¨è‰²
              'wuxia-red': '#dc2626',      // æœ±ç ‚ç´…
              'wuxia-red-dark': '#991b1b', // æ·±ç´…
              'wuxia-gold': '#fbbf24',     // äº®é‡‘
              'wuxia-gold-dark': '#b45309',// æš—é‡‘
              'wuxia-text': '#fce7f3',     // æ·ºç²‰ç™½æ–‡å­—
              'wuxia-jade': '#10b981',     // ç‰çŸ³ç¶ 
            },
            backgroundImage: {
              'pattern-cloud': "url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjUxLCAxOTEsIDM2LCAwLjEpIi8+PC9zdmc+')",
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #180a0a;
        background-image: radial-gradient(circle at 50% 0%, #451a1a 0%, #180a0a 70%);
        color: #fce7f3;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #2b1212; }
      ::-webkit-scrollbar-thumb { background: #78350f; border-radius: 4px; border: 1px solid #451a1a; }
      ::-webkit-scrollbar-thumb:hover { background: #92400e; }
      .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .text-glow { text-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
      /* Ensure Modals are on top */
      .z-modal { z-index: 60; }
      /* SweetAlert Customization */
      .swal2-popup { background: #2b1212 !important; border: 1px solid #fbbf24; color: #fce7f3 !important; }
      .swal2-title { color: #fbbf24 !important; }
      .swal2-confirm { background: linear-gradient(to right, #dc2626, #991b1b) !important; }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <!-- Main Application Code -->
    <script type="text/babel" data-presets="react">
      // ==========================================
      // è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸
      // ==========================================
      const LIFF_ID = '2008912922-0bJiM0sT'; 
      const LIFF_URL = `https://liff.line.me/${LIFF_ID}`;
      const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxo-_jcz9ApUTS6ENUAKYmg5ggT3h8AGAoulKlMZu4uSh-hx5yCC2qOr6XLLhedjKBsew/exec';
      const ADMIN_ID = 'Ua66fd77f72e4524075afd856cae91587'; // â˜… Admin LINE ID

      const LOGO_URL = 'https://placehold.co/200x200/991b1b/fbbf24?text=Game'; 
      const BANK_INFO = {
        code: '823',
        name: 'å°‡ä¾†éŠ€è¡Œ',
        account: '88618888888836'
      };
      
      const isGAS = typeof google !== 'undefined' && google.script;

      // ==========================================
      // æœå‹™å±¤ (Backend API)
      // ==========================================
      
      const withTimeout = (promise, ms = 30000) => {
          return Promise.race([
              promise,
              new Promise((_, reject) => setTimeout(() => reject(new Error("è«‹æ±‚é€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦")), ms))
          ]);
      };

      const getProducts = () => {
        return new Promise((resolve, reject) => {
          if (isGAS) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler((err) => reject(new Error(err.message || err)))
              .getProducts();
          } else {
            fetch(`${GAS_API_URL}?action=getProducts`)
              .then(res => res.json())
              .then(data => {
                 if (data.error) reject(new Error(data.error));
                 else resolve(data);
              })
              .catch(err => reject(err));
          }
        });
      };

      const getMyOrders = (userId) => {
        return new Promise((resolve, reject) => {
          if (isGAS) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler((err) => reject(new Error(err.message || err)))
              .getUserOrders(userId);
          } else {
             fetch(`${GAS_API_URL}?action=getUserOrders&userId=${userId}`)
              .then(res => res.json())
              .then(data => {
                 if (data.error) reject(new Error(data.error));
                 else resolve(data);
              })
              .catch(err => reject(err));
          }
        });
      };

      const getMemberProfileBackend = (userId) => {
         return new Promise((resolve, reject) => {
           if (isGAS) {
             google.script.run
               .withSuccessHandler(resolve)
               .withFailureHandler((err) => reject(new Error(err.message || err)))
               .getMemberProfile(userId);
           } else {
             fetch(`${GAS_API_URL}?action=getMemberProfile&userId=${userId}`)
               .then(res => res.json())
               .then(resolve).catch(reject);
           }
         });
      };

      const updateMemberProfileBackend = (data) => {
         return new Promise((resolve, reject) => {
            if (isGAS) {
               google.script.run
                 .withSuccessHandler(resolve)
                 .withFailureHandler((err) => reject(new Error(err.message || err)))
                 .updateMemberProfile(data);
            } else {
               fetch(GAS_API_URL, {
                 method: 'POST',
                 redirect: 'follow',
                 headers: { "Content-Type": "text/plain;charset=utf-8" },
                 body: JSON.stringify({ action: 'updateMemberProfile', ...data })
               })
               .then(res => res.json())
               .then(data => { if(data.success) resolve(data); else reject(new Error(data.message)); })
               .catch(reject);
            }
         });
      };

      const logUserToBackend = (user) => {
        if (isGAS) {
          google.script.run.logUserAccess(user);
        } else {
          fetch(GAS_API_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'logUserAccess', data: user })
          }).catch(console.error);
        }
      };

      const processCartOrderBackend = (user, paymentNote, cartItems) => {
        const itemsForBackend = cartItems.map(item => ({
            productId: item.product.id,
            quantity: item.quantity,
            name: item.product.name,
            price: item.product.price
        }));

        return new Promise((resolve, reject) => {
           if (isGAS) {
             google.script.run
               .withSuccessHandler(resolve)
               .withFailureHandler((err) => reject(new Error(err.message || err)))
               .processCartOrder(user, paymentNote, itemsForBackend);
           } else {
             fetch(GAS_API_URL, {
                method: 'POST',
                redirect: 'follow', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ 
                   action: 'processCartOrder', 
                   user: user, 
                   paymentNote: paymentNote, 
                   cartItems: itemsForBackend 
                })
             })
             .then(async res => {
                const text = await res.text();
                try { return JSON.parse(text); } catch (e) { throw new Error("ä¼ºæœå™¨å›æ‡‰ç•°å¸¸ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬æœªæ›´æ–°ã€‚"); }
             })
             .then(data => {
                if (data.success) resolve(data);
                else reject(new Error(data.message || 'Order failed'));
             })
             .catch(reject);
           }
        });
      };

      const updateOrderPaymentBackend = (userId, orderId, paymentNote) => {
        return new Promise((resolve, reject) => {
           if (isGAS) {
             google.script.run
               .withSuccessHandler(resolve)
               .withFailureHandler((err) => reject(new Error(err.message || err)))
               .updateOrderPayment(userId, orderId, paymentNote);
           } else {
             fetch(GAS_API_URL, {
                method: 'POST',
                redirect: 'follow', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ 
                   action: 'updateOrderPayment', 
                   userId: userId, 
                   orderId: orderId,
                   paymentNote: paymentNote
                })
             })
             .then(async res => {
                const text = await res.text();
                try { return JSON.parse(text); } catch (e) { throw new Error("ä¼ºæœå™¨å›æ‡‰ç•°å¸¸"); }
             })
             .then(data => {
                if (data.success) resolve(data);
                else reject(new Error(data.message || 'Update failed'));
             })
             .catch(reject);
           }
        });
      };

      const cancelOrderBackend = (userId, orderId) => {
        return new Promise((resolve, reject) => {
           if (isGAS) {
             google.script.run
               .withSuccessHandler(resolve)
               .withFailureHandler((err) => reject(new Error(err.message || err)))
               .cancelOrder(userId, orderId);
           } else {
             fetch(GAS_API_URL, {
                method: 'POST',
                redirect: 'follow', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ 
                   action: 'cancelOrder', 
                   userId: userId, 
                   orderId: orderId
                })
             })
             .then(res => res.json())
             .then(data => {
                if (data.success) resolve(data);
                else reject(new Error(data.message || 'Cancel failed'));
             })
             .catch(reject);
           }
        });
      };

      const submitIssueReport = (data) => {
        return new Promise((resolve, reject) => {
          if (isGAS) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler((err) => reject(new Error(err.message || err)))
              .submitIssue(data);
          } else {
             fetch(GAS_API_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'submitIssue', data: data })
             })
             .then(res => res.json())
             .then(data => {
                if (data.success) resolve(data);
                else reject(new Error(data.message || 'Report failed'));
             })
             .catch(reject);
          }
        });
      };
      
      // === Admin API ===
      const callAdminApi = (subAction, payload) => {
        return new Promise((resolve, reject) => {
          if (isGAS) {
             google.script.run
               .withSuccessHandler(resolve)
               .withFailureHandler(err => reject(new Error(err.message || err)))
               .handleAdminAction({ adminId: ADMIN_ID, subAction, payload });
          } else {
             fetch(GAS_API_URL, {
               method: 'POST',
               redirect: 'follow',
               headers: { "Content-Type": "text/plain;charset=utf-8" },
               body: JSON.stringify({ action: 'adminAction', adminId: ADMIN_ID, subAction, payload })
             })
             .then(res => res.json())
             .then(data => {
                if (data.success) resolve(data);
                else reject(new Error(data.message || 'Admin Action Failed'));
             })
             .catch(reject);
          }
        });
      };

      // ==========================================
      // Components
      // ==========================================

      const Navbar = ({ user, cartCount, onReport, onSuggest, onWallet, onProfile, onOpenCart, onLogin }) => {
        const isGuest = !user || user.userId === 'test-user';
        return (
          <nav className="fixed top-0 left-0 right-0 z-50 bg-[#180a0a]/95 backdrop-blur-sm border-b-2 border-wuxia-gold-dark shadow-lg shadow-black/50">
            <div className="container mx-auto px-4 h-20 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="relative group cursor-pointer">
                  <div className="absolute -inset-1 bg-gradient-to-r from-wuxia-red to-wuxia-gold rounded-full opacity-60 group-hover:opacity-90 blur transition duration-500 animate-pulse"></div>
                  <img src={LOGO_URL} alt="Logo" className="h-14 w-14 rounded-full relative bg-wuxia-bg object-cover border-2 border-wuxia-gold p-0.5" />
                </div>
                <div className="flex flex-col">
                  <div className="flex items-center gap-2">
                    <span className="font-bold text-xl text-transparent bg-clip-text bg-gradient-to-r from-wuxia-gold via-yellow-200 to-wuxia-gold tracking-wider drop-shadow-sm">éŠæˆ²æ–¹ç¨‹å¼</span>
                    <span className="text-[10px] bg-wuxia-gold/20 text-wuxia-gold border border-wuxia-gold/50 px-1 rounded font-mono">Ver 2.1</span>
                  </div>
                  <span className="text-[10px] text-red-400 font-mono uppercase tracking-[0.2em]">Game Equation</span>
                </div>
              </div>
              <div className="flex items-center gap-2 sm:gap-4">
                <button onClick={onOpenCart} className="relative p-2 text-wuxia-gold hover:text-white transition group mr-1">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  {cartCount > 0 && <span className="absolute -top-1 -right-1 bg-wuxia-red text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border border-wuxia-bg animate-bounce font-bold">{cartCount}</span>}
                </button>
                {!isGuest && (
                   <button onClick={onWallet} className="flex items-center gap-1 px-3 py-1.5 bg-stone-800 hover:bg-stone-700 border border-wuxia-gold/30 rounded text-wuxia-gold text-xs font-bold transition">
                     <span className="text-lg">ğŸ«</span><span className="hidden sm:inline">ç¥¨åˆ¸</span>
                   </button>
                )}
                <div className="hidden sm:flex items-center gap-2">
                  <button onClick={onReport} className="px-3 py-1 text-xs border border-wuxia-red/50 text-wuxia-red hover:bg-wuxia-red hover:text-white transition rounded">å›å ±</button>
                  <button onClick={onSuggest} className="px-3 py-1 text-xs border border-blue-500/50 text-blue-400 hover:bg-blue-600 hover:text-white transition rounded">åŠŸèƒ½å»ºè­°</button>
                </div>
                {!isGuest ? (
                  <button onClick={onProfile} className="flex items-center gap-3 pl-2 sm:pl-4 sm:border-l sm:border-wuxia-card hover:brightness-110 transition">
                    <img src={user.pictureUrl || 'https://picsum.photos/100/100'} alt={user.displayName} className="w-10 h-10 rounded-full border-2 border-wuxia-gold/70 shadow-md" />
                  </button>
                ) : (
                   <button onClick={onLogin} className="flex items-center gap-2 px-3 py-1.5 bg-[#06C755] hover:bg-[#05b34c] text-white rounded font-bold text-xs transition border border-[#05b34c] shadow-[0_0_10px_rgba(6,199,85,0.4)]">
                     <span className="font-bold">LINE ç™»å…¥</span>
                   </button>
                )}
              </div>
            </div>
          </nav>
        );
      };

      const ProductCard = ({ product, onAdd }) => {
        const category = (product.category || '').trim();
        const isMobile = category === 'æ‰‹æ©ŸéŠæˆ²';
        const isWeb = category === 'ç¶²é éŠæˆ²';
        
        let tagClass = 'bg-blue-900/80 border-blue-500 text-blue-100'; // PC default
        if (isMobile) tagClass = 'bg-purple-900/80 border-purple-500 text-purple-100';
        if (isWeb) tagClass = 'bg-green-900/80 border-green-500 text-green-100';

        return (
          <div className="group relative bg-wuxia-card rounded-lg overflow-hidden border border-wuxia-gold-dark/50 shadow-xl hover:shadow-wuxia-red/20 transition-all duration-300 hover:-translate-y-1 flex flex-col h-full bg-pattern-cloud">
            <div className="aspect-video w-full overflow-hidden bg-black relative border-b border-wuxia-gold-dark/30">
              <img src={product.imageUrl} alt={product.name} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-80 group-hover:opacity-100" />
              <div className={`absolute top-2 right-2 backdrop-blur-md px-3 py-0.5 rounded text-xs font-bold border shadow-lg tracking-widest ${tagClass}`}>{product.category}</div>
            </div>
            <div className="p-5 flex flex-col flex-grow relative">
              <h3 className="text-lg font-bold text-wuxia-gold mb-2 leading-tight group-hover:text-white transition-colors">{product.name}</h3>
              <p className="text-sm text-stone-400 mb-6 line-clamp-2 leading-relaxed font-serif tracking-wide">{product.description}</p>
              <div className="mt-auto flex items-end justify-between gap-3 pt-4 border-t border-white/5">
                <div className="flex flex-col"><span className="text-xs text-stone-500 font-mono mb-1">PRICE</span><span className="text-2xl font-mono text-white font-bold tracking-tight text-glow"><span className="text-base text-wuxia-gold mr-1">$</span>{product.price}</span></div>
                <button onClick={() => onAdd(product)} className="relative overflow-hidden px-6 py-2 bg-gradient-to-b from-wuxia-red to-wuxia-red-dark text-white rounded transition-all duration-300 font-bold text-sm shadow-lg hover:shadow-wuxia-red/50 border border-wuxia-gold/50 hover:border-wuxia-gold group-btn">
                  <span className="relative z-10 tracking-widest">åŠ å…¥è¡Œå›Š</span>
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-btn-hover:animate-shine"></div>
                </button>
              </div>
            </div>
          </div>
        );
      };

      const Modal = ({ isOpen, title, children, onClose, maxWidth = 'max-w-md' }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-modal flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/90 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
            <div className={`relative bg-[#2b1212] border-2 border-wuxia-gold w-full ${maxWidth} max-h-[90vh] flex flex-col rounded-lg shadow-[0_0_30px_rgba(0,0,0,0.8)] overflow-hidden animate-fadeIn`}>
              <div className="h-1 bg-gradient-to-r from-wuxia-gold-dark via-wuxia-gold to-wuxia-gold-dark shrink-0"></div>
              <div className="px-6 py-4 border-b border-wuxia-gold/20 flex justify-between items-center bg-black/20 shrink-0">
                <h3 className="text-xl font-bold text-wuxia-gold tracking-widest">{title}</h3>
                <button onClick={onClose} className="text-stone-500 hover:text-wuxia-red transition"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
              </div>
              <div className="p-6 bg-pattern-cloud overflow-y-auto custom-scrollbar">{children}</div>
            </div>
          </div>
        );
      };

      const ProfileModal = ({ isOpen, user, onClose }) => {
         const [loading, setLoading] = React.useState(false);
         const [formData, setFormData] = React.useState({ phone: '', email: '', gender: '' });

         React.useEffect(() => {
           if(isOpen && user) {
             setLoading(true);
             getMemberProfileBackend(user.userId)
               .then(data => { if(data.success) setFormData({ phone: data.phone, email: data.email, gender: data.gender || 'ä¸é€éœ²' }); })
               .finally(() => setLoading(false));
           }
         }, [isOpen, user]);

         const handleSave = () => {
            setLoading(true);
            updateMemberProfileBackend({ 
               userId: user.userId, 
               displayName: user.displayName, 
               phone: formData.phone, 
               email: formData.email, 
               gender: formData.gender 
            }).then(() => {
               Swal.fire({ toast:true, position:'top-end', icon:'success', title:'è³‡æ–™å·²æ›´æ–°', timer:1500, showConfirmButton:false, background:'#2b1212', color:'#fff' });
               onClose();
            }).catch(e => Swal.fire('Error', e.message, 'error'))
              .finally(() => setLoading(false));
         };

         return (
            <Modal isOpen={isOpen} title="æœƒå“¡è³‡æ–™å¡" onClose={onClose}>
               <div className="flex flex-col items-center mb-6">
                  <img src={user?.pictureUrl || 'https://placehold.co/100'} className="w-20 h-20 rounded-full border-2 border-wuxia-gold shadow-lg mb-2" />
                  <h3 className="text-lg font-bold text-white">{user?.displayName}</h3>
                  <p className="text-xs text-stone-500">{user?.userId}</p>
               </div>
               {loading ? <div className="text-center py-4 text-wuxia-gold animate-pulse">è®€å–ä¸­...</div> : (
                  <div className="space-y-4">
                     <div>
                        <label className="block text-xs text-wuxia-gold mb-1">è¯çµ¡é›»è©±</label>
                        <input type="tel" value={formData.phone} onChange={e => setFormData({...formData, phone:e.target.value})} className="w-full bg-black/40 border border-stone-600 rounded p-2 text-white" placeholder="09xx-xxx-xxx" />
                     </div>
                     <div>
                        <label className="block text-xs text-wuxia-gold mb-1">é›»å­ä¿¡ç®±</label>
                        <input type="email" value={formData.email} onChange={e => setFormData({...formData, email:e.target.value})} className="w-full bg-black/40 border border-stone-600 rounded p-2 text-white" placeholder="example@gmail.com" />
                     </div>
                     <div>
                        <label className="block text-xs text-wuxia-gold mb-1">æ€§åˆ¥</label>
                        <select value={formData.gender} onChange={e => setFormData({...formData, gender:e.target.value})} className="w-full bg-black/40 border border-stone-600 rounded p-2 text-white">
                           <option value="ç”·">ç”·</option>
                           <option value="å¥³">å¥³</option>
                           <option value="ä¸é€éœ²">ä¸é€éœ²</option>
                        </select>
                     </div>
                     <button onClick={handleSave} className="w-full py-2 bg-wuxia-red hover:bg-wuxia-red-dark text-white rounded font-bold mt-4 shadow-lg">å„²å­˜è®Šæ›´</button>
                  </div>
               )}
            </Modal>
         );
      };
      
      const GuideModal = ({ isOpen, onClose }) => {
        const [dontShow, setDontShow] = React.useState(false);
        
        const handleClose = () => {
            if (dontShow) {
                try { localStorage.setItem('game_equation_hide_guide_v2', 'true'); } catch(e){}
            }
            onClose();
        };

        if (!isOpen) return null;
        return (
           <Modal isOpen={isOpen} title="ğŸ“œ æ–°æ‰‹å…¥é–€æŒ‡å¼•" onClose={handleClose}>
             <div className="space-y-6">
                <div className="flex gap-4">
                   <div className="flex-shrink-0 w-8 h-8 rounded-full bg-wuxia-red text-white flex items-center justify-center font-bold border border-wuxia-gold">1</div>
                   <div><h4 className="text-wuxia-gold font-bold">æŒ‘é¸å¯¶ç‰©</h4><p className="text-stone-400 text-sm">ç€è¦½å•†å“åˆ—è¡¨ï¼Œé¸æ“‡æ‚¨éœ€è¦çš„éŠæˆ²è¼”åŠ©æˆ–è™›å¯¶ï¼Œé»æ“Šã€ŒåŠ å…¥è¡Œå›Šã€ã€‚</p></div>
                </div>
                <div className="flex gap-4">
                   <div className="flex-shrink-0 w-8 h-8 rounded-full bg-wuxia-red text-white flex items-center justify-center font-bold border border-wuxia-gold">2</div>
                   <div><h4 className="text-wuxia-gold font-bold">ç¢ºèªè¡Œå›Š</h4><p className="text-stone-400 text-sm">é»æ“Šå³ä¸Šè§’è³¼ç‰©è»Šåœ–ç¤ºï¼Œç¢ºèªæ•¸é‡ç„¡èª¤å¾Œï¼Œé»æ“Šã€Œæäº¤è¨‚å–®ã€ã€‚</p></div>
                </div>
                <div className="flex gap-4">
                   <div className="flex-shrink-0 w-8 h-8 rounded-full bg-wuxia-red text-white flex items-center justify-center font-bold border border-wuxia-gold">3</div>
                   <div><h4 className="text-wuxia-gold font-bold">å‚³é€é€šçŸ¥</h4><p className="text-stone-400 text-sm">ç³»çµ±æœƒè‡ªå‹•å¼•å°æ‚¨é–‹å•Ÿ LINEï¼Œè«‹é€å‡ºé è¨­è¨Šæ¯ä»¥å»ºç«‹è¨‚å–®ç´€éŒ„ã€‚</p></div>
                </div>
                <div className="flex gap-4">
                   <div className="flex-shrink-0 w-8 h-8 rounded-full bg-wuxia-red text-white flex items-center justify-center font-bold border border-wuxia-gold">4</div>
                   <div><h4 className="text-wuxia-gold font-bold">ä»˜æ¬¾å›å ±</h4><p className="text-stone-400 text-sm">ç•«é¢å°‡é¡¯ç¤ºåŒ¯æ¬¾å¸³è™Ÿã€‚è½‰å¸³å¾Œï¼Œè«‹å‹™å¿…è¼¸å…¥æ‚¨çš„ã€Œå¸³è™Ÿå¾Œäº”ç¢¼ã€ä¸¦é€å‡ºã€‚</p></div>
                </div>
                <div className="flex gap-4">
                   <div className="flex-shrink-0 w-8 h-8 rounded-full bg-wuxia-red text-white flex items-center justify-center font-bold border border-wuxia-gold">5</div>
                   <div><h4 className="text-wuxia-gold font-bold">è‡ªå‹•ç™¼è²¨</h4><p className="text-stone-400 text-sm">ç³»çµ±ç¢ºèªå…¥å¸³å¾Œ(ç´„5åˆ†é˜)ï¼Œè«‹è‡³ã€Œç¥¨åˆ¸å¤¾ã€é ˜å–æ‚¨çš„å¡è™Ÿèˆ‡å¯†ç¢¼ã€‚</p></div>
                </div>
                
                <div className="pt-2">
                    <div className="flex items-center gap-2 mb-3 justify-center">
                        <input type="checkbox" id="no-guide" checked={dontShow} onChange={e => setDontShow(e.target.checked)} className="w-4 h-4 accent-wuxia-red cursor-pointer" />
                        <label htmlFor="no-guide" className="text-stone-400 text-sm cursor-pointer select-none">ä¸‹æ¬¡ä¸å†é¡¯ç¤ºæ­¤è¨Šæ¯</label>
                    </div>
                    <button onClick={handleClose} className="w-full py-3 bg-gradient-to-r from-wuxia-gold-dark to-wuxia-gold text-black font-bold rounded shadow-lg hover:brightness-110 transition">æˆ‘å·²ç­è§£ï¼Œé–‹å§‹å†’éšªï¼</button>
                </div>
             </div>
           </Modal>
        );
      };

      // Admin Modal
      const AdminModal = ({ isOpen, onClose }) => {
        const [activeTab, setActiveTab] = React.useState('orders');
        const [data, setData] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [refreshKey, setRefreshKey] = React.useState(0);
        
        // Inventory Form State
        const [invProdId, setInvProdId] = React.useState('');
        const [invCode, setInvCode] = React.useState('');
        const [invPass, setInvPass] = React.useState('');

        React.useEffect(() => {
          if(isOpen) {
             setLoading(true);
             callAdminApi('getDashboardData')
               .then(res => setData(res))
               .catch(err => Swal.fire('Error', err.message, 'error'))
               .finally(() => setLoading(false));
          }
        }, [isOpen, refreshKey]);

        const refresh = () => setRefreshKey(k => k+1);

        const handleFulfill = (rowIndex, orderId) => {
           Swal.fire({
             title: 'ç¢ºèªå¼·åˆ¶ç™¼è²¨ï¼Ÿ', text: `å–®è™Ÿï¼š${orderId}`, icon: 'warning', showCancelButton:true, confirmButtonText:'ç™¼è²¨', cancelButtonText:'å–æ¶ˆ'
           }).then(r => {
             if(r.isConfirmed) {
                callAdminApi('manualFulfill', { rowIndex })
                .then(() => { Swal.fire('æˆåŠŸ', 'å·²åŸ·è¡Œç™¼è²¨ç¨‹åº', 'success'); refresh(); })
                .catch(e => Swal.fire('å¤±æ•—', e.message, 'error'));
             }
           });
        };

        const handleAddStock = () => {
           if(!invProdId || !invCode) return Swal.fire('æ¬„ä½ä¸è¶³', 'è«‹é¸æ“‡å•†å“ä¸¦è¼¸å…¥å¡è™Ÿ', 'warning');
           setLoading(true);
           callAdminApi('addInventory', { 
             productId: invProdId, 
             items: [{ code: invCode, pass: invPass }] 
           }).then(() => {
              Swal.fire('æˆåŠŸ', 'åº«å­˜å·²æ–°å¢', 'success');
              setInvCode(''); setInvPass(''); refresh();
           }).catch(e => Swal.fire('å¤±æ•—', e.message, 'error'))
             .finally(() => setLoading(false));
        };
        
        const handleDeleteStock = (rowIndex) => {
           if(!confirm('ç¢ºå®šåˆªé™¤æ­¤åº«å­˜ï¼Ÿ')) return;
           callAdminApi('deleteInventory', { rowIndex }).then(refresh);
        };

        return (
          <Modal isOpen={isOpen} title="æŒé–€å¯†å®¤ (å¾Œå°)" onClose={onClose} maxWidth="max-w-4xl">
             <div className="flex gap-2 mb-4 border-b border-stone-700 pb-2">
               {['orders', 'inventory', 'users'].map(tab => (
                 <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded font-bold ${activeTab === tab ? 'bg-wuxia-red text-white' : 'bg-stone-800 text-stone-400 hover:bg-stone-700'}`}>
                   {tab === 'orders' ? 'ğŸ“œ è¨‚å–®ç®¡ç†' : tab === 'inventory' ? 'ğŸ“¦ åº«å­˜ç®¡ç†' : 'ğŸ‘¥ ç”¨æˆ¶åå†Š'}
                 </button>
               ))}
               <button onClick={refresh} className="ml-auto px-3 py-1 bg-stone-700 rounded text-xs text-stone-300">ğŸ”„ é‡æ–°æ•´ç†</button>
             </div>

             {loading && !data && <div className="text-center py-10 text-wuxia-gold animate-pulse">è®€å–å·å®—ä¸­...</div>}
             
             {data && (
               <>
                 {/* è¨‚å–®ç®¡ç† TAB */}
                 {activeTab === 'orders' && (
                   <div className="space-y-4">
                      {data.orders.length === 0 ? <p className="text-center text-stone-500">ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®ã€‚</p> : 
                        data.orders.map((ord, i) => (
                           <div key={i} className="bg-black/30 p-3 rounded border border-wuxia-gold/20 flex justify-between items-center">
                              <div>
                                 <p className="text-wuxia-gold font-bold text-sm">{ord.productName} <span className="text-stone-400 text-xs">(${ord.price})</span></p>
                                 <p className="text-xs text-stone-400">{ord.orderId} | {ord.userName}</p>
                                 <p className="text-xs text-stone-500">{ord.date} | å‚™è¨»: <span className="text-white">{ord.paymentNote || 'ç„¡'}</span></p>
                              </div>
                              <button onClick={() => handleFulfill(ord.rowIndex, ord.orderId)} className="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">å¼·åˆ¶ç™¼è²¨</button>
                           </div>
                        ))
                      }
                   </div>
                 )}
                 
                 {/* åº«å­˜ç®¡ç† TAB */}
                 {activeTab === 'inventory' && (
                   <div>
                      <div className="bg-stone-900 p-4 rounded mb-6 border border-stone-700">
                         <h4 className="text-sm font-bold text-wuxia-gold mb-2">æ–°å¢åº«å­˜</h4>
                         <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <select value={invProdId} onChange={e => setInvProdId(e.target.value)} className="bg-black border border-stone-600 rounded p-2 text-white text-xs">
                               <option value="">-- é¸æ“‡å•†å“ --</option>
                               {data.products.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            <input type="text" placeholder="å¡è™Ÿ / Code" value={invCode} onChange={e => setInvCode(e.target.value)} className="bg-black border border-stone-600 rounded p-2 text-white text-xs" />
                            <input type="text" placeholder="å¯†ç¢¼ / Password (é¸å¡«)" value={invPass} onChange={e => setInvPass(e.target.value)} className="bg-black border border-stone-600 rounded p-2 text-white text-xs" />
                            <button onClick={handleAddStock} className="bg-blue-700 hover:bg-blue-600 text-white rounded font-bold text-xs">æ–°å¢</button>
                         </div>
                      </div>
                      <div className="space-y-2 h-64 overflow-y-auto pr-2">
                         {data.inventory.map((inv, i) => (
                            <div key={i} className="flex justify-between items-center bg-black/20 p-2 rounded border border-stone-800">
                               <div className="overflow-hidden">
                                  <p className="text-stone-300 text-xs font-bold truncate">{inv.productName}</p>
                                  <p className="text-[10px] text-stone-500 font-mono">Code: {inv.code} / Pass: {inv.password || 'N/A'}</p>
                               </div>
                               <div className="flex items-center gap-2 shrink-0">
                                  <span className={`text-[10px] px-1 rounded ${inv.status==='Available'?'bg-green-900 text-green-300':'bg-red-900 text-red-300'}`}>{inv.status}</span>
                                  <button onClick={() => handleDeleteStock(inv.rowIndex)} className="text-red-500 hover:text-red-300 text-xs border border-red-900 px-2 rounded">åˆª</button>
                               </div>
                            </div>
                         ))}
                      </div>
                   </div>
                 )}

                 {/* ç”¨æˆ¶åˆ—è¡¨ TAB */}
                 {activeTab === 'users' && (
                   <div className="space-y-2">
                      {data.users.map((u, i) => (
                         <div key={i} className="flex justify-between p-2 border-b border-stone-800">
                            <div><p className="text-sm text-stone-200">{u.name}</p><p className="text-[10px] text-stone-500">{u.uid}</p></div>
                            <span className="text-xs text-stone-600">{u.date}</span>
                         </div>
                      ))}
                   </div>
                 )}
               </>
             )}
          </Modal>
        );
      };

      const WalletModal = ({ isOpen, user, onClose, onLogin, onOpenAdmin, onCancelOrder, onReportPayment }) => {
         const [orders, setOrders] = React.useState([]);
         const [loading, setLoading] = React.useState(false);
         const isAdmin = user && user.userId === ADMIN_ID;

         React.useEffect(() => {
            if(isOpen && user) {
               if (user.userId === 'test-user') return;
               setLoading(true);
               getMyOrders(user.userId)
                  .then(data => { setOrders(data); setLoading(false); })
                  .catch((err) => { 
                     setLoading(false); 
                     Swal.fire({ icon: 'error', title: 'ç„¡æ³•è®€å–ç¥¨åˆ¸', text: 'è«‹ç¨å¾Œå†è©¦ (' + (err.message || 'Unknown') + ')', background: '#2b1212', color: '#fff' });
                  });
            }
         }, [isOpen, user]);

         return (
            <Modal isOpen={isOpen} title="æˆ‘çš„ç¥¨åˆ¸å¤¾" onClose={onClose}>
               {user && (
                 <div className="mb-4 p-2 bg-white/5 rounded border border-white/10 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                       <img src={user.pictureUrl || 'https://placehold.co/100'} className="w-8 h-8 rounded-full border border-stone-600"/>
                       <div><p className="text-xs text-stone-400">ç›®å‰å¸³è™Ÿ</p><p className="text-sm font-bold text-wuxia-gold">{user.displayName}</p></div>
                    </div>
                    <div className="flex gap-2">
                       {isAdmin && (
                         <button onClick={onOpenAdmin} className="text-xs bg-red-900/80 hover:bg-red-700 text-red-200 border border-red-500 px-2 py-1 rounded animate-pulse font-bold">
                           é€²å…¥æŒé–€å¯†å®¤
                         </button>
                       )}
                       <div className="text-right"><span className="text-[10px] text-stone-500 bg-black/50 px-2 py-1 rounded border border-stone-800">ID: {user.userId ? user.userId.substring(0,6)+'...' : 'Unknown'}</span></div>
                    </div>
                 </div>
               )}
               {user && user.userId === 'test-user' ? (
                  <div className="text-center py-10">
                     <p className="text-stone-500 mb-4">æ‚¨ç›®å‰è™•æ–¼è¨ªå®¢æ¨¡å¼ï¼Œç„¡æ³•æŸ¥çœ‹ç¥¨åˆ¸ã€‚</p>
                     <button onClick={onLogin} className="px-6 py-2 bg-[#06C755] text-white rounded font-bold hover:bg-[#05b34c] transition shadow-lg">ä½¿ç”¨ LINE ç™»å…¥</button>
                  </div>
               ) : loading ? <div className="text-center py-10 text-wuxia-gold animate-pulse">è®€å–ä¸­...</div> : orders.length === 0 ? <div className="text-center py-10 text-stone-500">å°šç„¡è³¼è²·ç´€éŒ„</div> : (
                  <div className="space-y-4">
                     {orders.map((order, idx) => (
                        <div key={idx} className="bg-black/30 border border-wuxia-gold/30 rounded p-4">
                           <div className="flex justify-between items-start mb-2 border-b border-white/10 pb-2">
                              <div>
                                <h4 className="text-white font-bold">{order.productName}</h4>
                                <div className="flex gap-2 items-center mt-1">
                                  <p className="text-xs text-stone-500">{new Date(order.date).toLocaleString()}</p>
                                  {order.status === 'å¾…è™•ç†' && <span className="text-[10px] bg-yellow-900/50 text-yellow-500 border border-yellow-700 px-1 rounded animate-pulse">å¾…è™•ç†</span>}
                                  {order.status === 'å·²ç™¼è²¨' && <span className="text-[10px] bg-green-900/50 text-green-500 border border-green-700 px-1 rounded">å·²å®Œæˆ</span>}
                                  {order.status === 'å·²å–æ¶ˆ' && <span className="text-[10px] bg-stone-700 text-stone-400 border border-stone-600 px-1 rounded">å·²å–æ¶ˆ</span>}
                                </div>
                              </div>
                              <div className="text-right"><span className="text-wuxia-gold font-mono block">${order.price}</span><span className="text-[10px] text-stone-400">x{order.quantity}</span></div>
                           </div>
                           {/* Content area based on status */}
                           {order.status === 'å¾…è™•ç†' && (
                              <div className="text-center py-4 bg-stone-800/30 rounded border border-dashed border-stone-700 mt-2">
                                <p className="text-wuxia-gold text-sm font-bold">ç­‰å¾…å…¥å¸³ç¢ºèªä¸­</p>
                                <p className="text-xs text-stone-500 mt-1 mb-3">è‹¥å·²åŒ¯æ¬¾è«‹é»æ“Šå›å ±ï¼Œç³»çµ±æ ¸å°å¾Œè‡ªå‹•ç™¼å¡</p>
                                <div className="flex justify-center gap-2">
                                    <button onClick={() => onReportPayment(order.orderId, order.price)} className="px-3 py-1 bg-wuxia-gold text-black text-xs font-bold rounded hover:bg-white transition">åŒ¯æ¬¾å›å ±</button>
                                    <button onClick={() => onCancelOrder(order.orderId)} className="px-3 py-1 border border-stone-600 text-stone-400 text-xs rounded hover:bg-stone-800 transition">å–æ¶ˆè¨‚å–®</button>
                                </div>
                              </div>
                           )}
                           {order.status === 'å·²ç™¼è²¨' && (
                              <div className="space-y-2 mt-2">
                                 <div className="bg-[#1a0f0f] p-2 rounded border border-wuxia-jade/20 relative group/code">
                                   <div className="flex justify-between"><p className="text-[10px] text-stone-500 uppercase">åºè™Ÿ / Codes</p><button onClick={() => { navigator.clipboard.writeText(order.codes); Swal.fire({toast:true, position:'top-end', icon:'success', title:'è¤‡è£½æˆåŠŸ', timer:1500, showConfirmButton:false, background:'#2b1212', color:'#fff'}); }} className="text-[10px] text-wuxia-jade underline">è¤‡è£½</button></div>
                                   <pre className="text-wuxia-jade font-mono text-sm whitespace-pre-wrap select-all">{order.codes}</pre>
                                 </div>
                                 {order.passwords && order.passwords.trim() !== '' && (
                                   <div className="bg-[#1a0f0f] p-2 rounded border border-wuxia-jade/20">
                                      <p className="text-[10px] text-stone-500 uppercase">å¯†ç¢¼ / Passwords</p>
                                      <pre className="text-wuxia-jade font-mono text-sm whitespace-pre-wrap select-all">{order.passwords}</pre>
                                   </div>
                                 )}
                              </div>
                           )}
                           {order.status === 'å·²å–æ¶ˆ' && (
                               <div className="text-center py-2"><p className="text-xs text-stone-600">æ­¤è¨‚å–®å·²å–æ¶ˆ</p></div>
                           )}
                        </div>
                     ))}
                  </div>
               )}
            </Modal>
         );
      };

      const ReportModal = ({ isOpen, user, onClose, onLogin, initialType, products }) => {
        const [type, setType] = React.useState(initialType || 'å……å€¼å•é¡Œ');
        const [desc, setDesc] = React.useState('');
        const [relatedProduct, setRelatedProduct] = React.useState(''); // New State
        const [status, setStatus] = React.useState('idle');

        React.useEffect(() => {
           if(isOpen && initialType) setType(initialType);
        }, [isOpen, initialType]);

        const handleSubmit = async () => {
          if (!user || user.userId === 'test-user') return Swal.fire({ icon: 'warning', title: 'è«‹å…ˆç™»å…¥', confirmButtonText: 'ç™»å…¥', preConfirm: onLogin });
          if (!desc.trim()) return Swal.fire({ icon: 'warning', title: 'è«‹å¡«å¯«æè¿°', confirmButtonText: 'å¥½' });
          setStatus('submitting');
          try {
            await submitIssueReport({ 
               userId: user.userId, 
               displayName: user.displayName, 
               type, 
               description: desc,
               productName: relatedProduct // Pass product name
            });
            setStatus('success');
            setTimeout(() => { onClose(); setStatus('idle'); setDesc(''); setRelatedProduct(''); }, 2000);
          } catch(e) { Swal.fire({ icon: 'error', title: 'ç™¼é€å¤±æ•—' }); setStatus('idle'); }
        };
        if (status === 'success') return <Modal isOpen={isOpen} title="å›å ±æˆåŠŸ" onClose={onClose}><div className="text-center py-8"><div className="text-wuxia-jade text-5xl mb-4">âœ“</div><p className="text-stone-300">æ‚¨çš„é£›é´¿å‚³æ›¸å·²é€é”ï¼</p></div></Modal>;
        return (
          <Modal isOpen={isOpen} title="å•é¡Œå›å ± / åŠŸèƒ½å»ºè­°" onClose={onClose}>
            <div className="space-y-4">
              <div><label className="block text-xs text-wuxia-gold mb-1">å•é¡Œé¡å‹</label><select value={type} onChange={e => setType(e.target.value)} className="w-full bg-black/40 border border-stone-600 rounded p-2 text-stone-200 outline-none"><option value="å……å€¼å•é¡Œ">å……å€¼å•é¡Œ</option><option value="åºè™Ÿç„¡æ•ˆ">åºè™Ÿç„¡æ•ˆ</option><option value="å•†å“å»ºè­°">å•†å“å»ºè­°</option><option value="åŠŸèƒ½å»ºè­°">åŠŸèƒ½å»ºè­°</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
              <div>
                  <label className="block text-xs text-wuxia-gold mb-1">ç›¸é—œå•†å“ (è¼”åŠ©åç¨±)</label>
                  <select value={relatedProduct} onChange={e => setRelatedProduct(e.target.value)} className="w-full bg-black/40 border border-stone-600 rounded p-2 text-stone-200 outline-none">
                     <option value="">-- è«‹é¸æ“‡ (è‹¥ç„¡å¯ä¸é¸) --</option>
                     {products && products.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                     <option value="General">ä¸€èˆ¬/ç³»çµ±å•é¡Œ</option>
                  </select>
              </div>
              <div><label className="block text-xs text-wuxia-gold mb-1">è©³ç´°æè¿°</label><textarea value={desc} onChange={e => setDesc(e.target.value)} rows={4} className="w-full bg-black/40 border border-stone-600 rounded p-2 text-stone-200 outline-none"></textarea></div>
              <div className="pt-2"><button onClick={handleSubmit} disabled={status === 'submitting'} className="w-full py-2 bg-wuxia-red hover:bg-wuxia-red-dark text-white rounded font-bold transition disabled:opacity-50">{status === 'submitting' ? 'ç™¼é€ä¸­...' : 'æäº¤å›å ±'}</button></div>
            </div>
          </Modal>
        );
      }

      // ==========================================
      // App
      // ==========================================
      const App = () => {
        const [products, setProducts] = React.useState([]);
        const [user, setUser] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        
        const [cart, setCart] = React.useState([]);
        const [showCart, setShowCart] = React.useState(false);
        const [cartTotal, setCartTotal] = React.useState(0);

        const [tempProduct, setTempProduct] = React.useState(null);
        const [tempQty, setTempQty] = React.useState(1);

        const [showBankInfo, setShowBankInfo] = React.useState(false); 
        const [paymentNote, setPaymentNote] = React.useState(''); 
        const [currentOrderId, setCurrentOrderId] = React.useState(null); 
        const [currentOrderPrice, setCurrentOrderPrice] = React.useState(0);
        
        const [showReport, setShowReport] = React.useState(false);
        const [reportInitType, setReportInitType] = React.useState('å……å€¼å•é¡Œ');
        const [showWallet, setShowWallet] = React.useState(false);
        const [showAdmin, setShowAdmin] = React.useState(false); 
        const [showGuide, setShowGuide] = React.useState(false); 
        const [showProfile, setShowProfile] = React.useState(false); // â˜… Profile Modal State

        const [isProcessing, setIsProcessing] = React.useState(false);
        const [activeCategory, setActiveCategory] = React.useState('å…¨éƒ¨');

        React.useEffect(() => {
           setCartTotal(cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0));
        }, [cart]);

        const loginWithLiffUrl = () => { window.top.location.href = LIFF_URL; };

        const initLiff = React.useCallback(async () => {
          try {
             if (!window.liff) throw new Error("LIFF SDK æœªè¼‰å…¥");
             await window.liff.init({ liffId: LIFF_ID });
             if (window.liff.isLoggedIn()) {
                const profile = await window.liff.getProfile();
                const userData = { userId: profile.userId, displayName: profile.displayName, pictureUrl: profile.pictureUrl, os: window.liff.getOS() };
                setUser(userData);
                logUserToBackend(userData);
             } else {
                setUser({ userId: 'test-user', displayName: 'è¨ªå®¢', pictureUrl: '', os: 'web' });
             }
             // â˜… Check LocalStorage for guide preference
             const hasSeenGuide = localStorage.getItem('game_equation_hide_guide_v2');
             if (!hasSeenGuide) setShowGuide(true);
          } catch (err) {
            console.error('LIFF Error:', err);
            setUser({ userId: 'test-user', displayName: 'é›¢ç·šæ¸¬è©¦å“¡', pictureUrl: '', os: 'web' });
            setError('LIFF åˆå§‹åŒ–å¤±æ•—');
          }
        }, []);

        const fetchProducts = React.useCallback(async () => {
          setLoading(true);
          try {
            const data = await getProducts();
            setProducts(data);
          } catch (err) { setError('ç„¡æ³•è®€å–å•†å“åˆ—è¡¨'); } finally { setLoading(false); }
        }, []);

        React.useEffect(() => { initLiff(); fetchProducts(); }, [initLiff, fetchProducts]);

        const filteredProducts = React.useMemo(() => {
          if (activeCategory === 'å…¨éƒ¨') return products;
          return products.filter(p => (p.category || '').trim() === activeCategory);
        }, [products, activeCategory]);

        const categories = ['å…¨éƒ¨', 'é›»è…¦éŠæˆ²', 'æ‰‹æ©ŸéŠæˆ²', 'ç¶²é éŠæˆ²']; // â˜… Added Web Game

        const openAddToCart = (product) => { setTempProduct(product); setTempQty(1); };
        const confirmAddToCart = () => {
           if (!tempProduct) return;
           setCart(prev => {
              const existing = prev.find(item => item.product.id === tempProduct.id);
              if (existing) return prev.map(item => item.product.id === tempProduct.id ? { ...item, quantity: item.quantity + tempQty } : item);
              return [...prev, { product: tempProduct, quantity: tempQty }];
           });
           setTempProduct(null);
           Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'å·²åŠ å…¥è¡Œå›Š', showConfirmButton: false, timer: 1500, background: '#2b1212', color: '#fff' });
        };
        const removeFromCart = (productId) => { setCart(prev => prev.filter(item => item.product.id !== productId)); };
        const updateCartQuantity = (productId, delta) => {
           setCart(prev => prev.map(item => item.product.id === productId ? { ...item, quantity: Math.max(1, item.quantity + delta) } : item));
        };

        const submitOrder = async () => {
           if (cart.length === 0) return;
           if (!user || user.userId === 'test-user') {
              Swal.fire({ icon: 'info', title: 'è«‹å…ˆç™»å…¥', showCancelButton: true, confirmButtonText: 'LINE ç™»å…¥' }).then((r) => { if (r.isConfirmed) loginWithLiffUrl(); });
              return;
           }
           setIsProcessing(true);
           try {
             const result = await withTimeout(processCartOrderBackend({ userId: user.userId, displayName: user.displayName }, "", cart), 30000);
             if (result.success) {
               if (window.liff && window.liff.isInClient()) {
                 const itemListStr = cart.map(item => `- ${item.product.name} x${item.quantity}`).join('\n');
                 try {
                   await window.liff.sendMessages([{
                     type: 'text',
                     text: `ã€è¨‚å–®å·²æˆç«‹ã€‘\nå–®è™Ÿï¼š${result.orderId}\né‡‘é¡ï¼š$${cartTotal}\n\nè«‹ä¾ç…§ç¶²é æŒ‡ç¤ºé€²è¡Œä»˜æ¬¾ï¼Œå®Œæˆå¾Œæ‚¨çš„å•†å“å°‡æœƒè‡ªå‹•ç™¼é€ã€‚`
                   }]);
                 } catch (msgErr) { console.error("Line Msg Error:", msgErr); }
               }
               setCart([]); 
               setCurrentOrderId(result.orderId); 
               setCurrentOrderPrice(cartTotal); // Set price for bank modal
               setShowCart(false); 
               setShowBankInfo(true);
             } else {
               Swal.fire({ icon: 'error', title: 'è¨‚å–®å»ºç«‹å¤±æ•—', text: result.message });
             }
           } catch (err) {
             console.error("Order Error:", err);
             Swal.fire({ icon: 'error', title: 'ç³»çµ±ç¹å¿™', text: err.message });
           } finally {
             setIsProcessing(false);
           }
        };

        const confirmPaymentInfo = async () => {
           if (!paymentNote.trim()) return Swal.fire({ icon: 'warning', title: 'è«‹è¼¸å…¥å¾Œäº”ç¢¼', text: 'æˆ‘å€‘éœ€è¦é€™é …è³‡è¨Šä¾†å°å¸³' });
           if (!currentOrderId) return Swal.fire({ icon: 'error', title: 'è¨‚å–®ç·¨è™Ÿéºå¤±', text: 'è«‹é‡æ–°æ•´ç†é é¢' });
           setIsProcessing(true);
           try {
             const result = await updateOrderPaymentBackend(user.userId, currentOrderId, paymentNote);
             if (result.success) {
                setShowBankInfo(false); setPaymentNote(''); setCurrentOrderId(null);
                Swal.fire({ icon: 'success', title: 'ä»˜æ¬¾è³‡è¨Šå·²æ›´æ–°', html: '<p class="text-stone-300">ç³»çµ±æ­£åœ¨æ ¸å°æ‚¨çš„æ¬¾é …ã€‚<br/>æ ¸å°æˆåŠŸå¾Œï¼Œå•†å“å°‡è‡ªå‹•ç™¼é€åˆ°æ‚¨çš„ç¥¨åˆ¸å¤¾ã€‚</p>', confirmButtonText: 'å¥½çš„ï¼Œæˆ‘å»ç¥¨åˆ¸å¤¾çœ‹çœ‹' }).then((r) => { if (r.isConfirmed) setShowWallet(true); });
             } else {
                Swal.fire({ icon: 'error', title: 'æ›´æ–°å¤±æ•—', text: result.message });
             }
           } catch (err) { Swal.fire({ icon: 'error', title: 'é€£ç·šéŒ¯èª¤', text: err.message }); } finally { setIsProcessing(false); }
        };

        const copyToClipboard = (text) => {
             if (navigator.clipboard) { navigator.clipboard.writeText(text); Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'å·²è¤‡è£½', timer: 1500, showConfirmButton:false, background:'#2b1212', color:'#fff' }); }
        };
        
        const handleWalletReportPayment = (orderId, price) => {
           setCurrentOrderId(orderId);
           setCurrentOrderPrice(price);
           setShowWallet(false);
           setShowBankInfo(true);
        };

        const handleWalletCancelOrder = async (orderId) => {
           const r = await Swal.fire({
              title: 'å–æ¶ˆè¨‚å–®ï¼Ÿ', text: 'ç¢ºå®šè¦å–æ¶ˆé€™ç­†å°šæœªä»˜æ¬¾çš„è¨‚å–®å—ï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonText: 'ç¢ºå®šå–æ¶ˆ', cancelButtonText: 'ä¿ç•™', background: '#2b1212', color: '#fff'
           });
           if(r.isConfirmed) {
              try {
                 const result = await cancelOrderBackend(user.userId, orderId);
                 if(result.success) {
                    Swal.fire({icon:'success', title:'å·²å–æ¶ˆ', timer:1500, showConfirmButton:false});
                    setShowWallet(false); // Close to force refresh next open, or could reload
                 } else {
                    Swal.fire({icon:'error', title:'å–æ¶ˆå¤±æ•—', text:result.message});
                 }
              } catch(e) { Swal.fire({icon:'error', title:'éŒ¯èª¤', text:e.message}); }
           }
        };

        return (
          <div className="min-h-screen pb-20">
            <Navbar 
                user={user} 
                cartCount={cart.reduce((a,b)=>a+b.quantity, 0)} 
                onReport={() => { setReportInitType('å……å€¼å•é¡Œ'); setShowReport(true); }} 
                onSuggest={() => { setReportInitType('åŠŸèƒ½å»ºè­°'); setShowReport(true); }}
                onWallet={() => { if(!user || user.userId === 'test-user') return Swal.fire({icon:'info', title:'è«‹å…ˆç™»å…¥', showCancelButton:true, confirmButtonText:'LINE ç™»å…¥', cancelButtonText:'å–æ¶ˆ'}).then(r => { if(r.isConfirmed) loginWithLiffUrl(); }); setShowWallet(true); }} 
                onProfile={() => setShowProfile(true)} // â˜… Profile Handler
                onOpenCart={() => setShowCart(true)} 
                onLogin={loginWithLiffUrl} 
            />

            <main className="container mx-auto px-4 pt-24">
              <div className="mb-12 text-center relative">
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-wuxia-red/20 blur-[80px] rounded-full -z-10 animate-pulse"></div>
                <h1 className="text-4xl md:text-5xl font-extrabold text-white mb-3 tracking-tight"><span className="text-transparent bg-clip-text bg-gradient-to-r from-wuxia-gold via-yellow-100 to-wuxia-gold drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">éŠæˆ²æ–¹ç¨‹å¼</span>
                <p className="text-sm text-wuxia-gold/80 mb-1 font-serif tracking-widest mt-2">é‡‹æ”¾ä½ çš„é›™æ‰‹</p>
                <span className="block text-xl mt-1 font-normal text-red-300 font-serif tracking-widest">è™›å¯¶è£œçµ¦è‡ªå‹•ç™¼è²¨ç«™</span></h1>
                <div className="sm:hidden mt-4 flex justify-center gap-4">
                    {user && user.userId !== 'test-user' && <button onClick={() => setShowWallet(true)} className="text-xs text-wuxia-gold underline">æˆ‘çš„ç¥¨åˆ¸å¤¾</button>}
                    <button onClick={() => { setReportInitType('å……å€¼å•é¡Œ'); setShowReport(true); }} className="text-xs text-wuxia-red underline">é‡åˆ°å•é¡Œï¼Ÿ</button>
                    <button onClick={() => { setReportInitType('åŠŸèƒ½å»ºè­°'); setShowReport(true); }} className="text-xs text-blue-400 underline">åŠŸèƒ½å»ºè­°</button>
                </div>
              </div>

              <div className="flex justify-center mb-10 gap-4">
                {categories.map(cat => (
                  <button key={cat} onClick={() => setActiveCategory(cat)} className={`px-6 py-2 rounded border transition-all duration-300 font-bold text-sm tracking-wider transform ${activeCategory === cat ? 'bg-wuxia-red text-white border-wuxia-red shadow-[0_0_15px_rgba(220,38,38,0.5)] scale-110' : 'bg-transparent text-stone-500 border-stone-700 hover:border-stone-400 hover:text-stone-300'}`}>{cat}</button>
                ))}
              </div>

              {error && <div className="bg-red-900/30 border border-red-800 text-red-300 p-4 rounded-lg text-center mb-6 whitespace-pre-wrap">{error}</div>}

              {loading ? (
                <div className="flex justify-center items-center h-64 flex-col gap-4"><div className="animate-spin rounded-full h-12 w-12 border-4 border-wuxia-card border-t-wuxia-gold"></div><p className="text-wuxia-gold text-sm tracking-widest animate-pulse">æ­£åœ¨è®€å–å·è»¸...</p></div>
              ) : (
                <>
                  {filteredProducts.length === 0 ? <div className="text-center py-20 text-stone-600 border-2 border-dashed border-stone-800 rounded-lg">æ­¤åˆ†é¡ç›®å‰æ²’æœ‰å¯¶ç‰©</div> : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">{filteredProducts.map((product) => (<ProductCard key={product.id} product={product} onAdd={openAddToCart} />))}</div>
                  )}
                </>
              )}
            </main>

            <Modal isOpen={!!tempProduct} title="åŠ å…¥è¡Œå›Š" onClose={() => setTempProduct(null)}>
                {tempProduct && (
                  <div className="text-center space-y-4">
                    <div className="w-full h-32 rounded border border-wuxia-gold/30 overflow-hidden mb-4 relative bg-black"><img src={tempProduct.imageUrl} alt={tempProduct.name} className="w-full h-full object-cover opacity-80" /></div>
                    <h3 className="text-xl font-bold text-white tracking-wide">{tempProduct.name}</h3>
                    <div className="flex items-center justify-center gap-4 my-4">
                        <button onClick={() => setTempQty(Math.max(1, tempQty - 1))} className="w-8 h-8 rounded bg-stone-700 text-white font-bold hover:bg-wuxia-red transition">-</button>
                        <span className="text-xl font-mono font-bold text-wuxia-gold w-8">{tempQty}</span>
                        <button onClick={() => setTempQty(Math.min(10, tempQty + 1))} className="w-8 h-8 rounded bg-stone-700 text-white font-bold hover:bg-wuxia-red transition">+</button>
                    </div>
                    <div className="bg-black/40 px-6 py-2 rounded-full border border-wuxia-gold/30 inline-block"><p className="text-stone-400 text-xs">å°è¨ˆ</p><p className="text-2xl text-wuxia-gold font-mono font-bold">${tempProduct.price * tempQty}</p></div>
                    <div className="flex gap-4 mt-8">
                      <button onClick={() => setTempProduct(null)} className="flex-1 px-4 py-3 rounded border border-stone-600 text-stone-400 hover:bg-stone-800 transition text-sm">å–æ¶ˆ</button>
                      <button onClick={confirmAddToCart} className="flex-1 px-4 py-3 rounded bg-gradient-to-r from-wuxia-red to-wuxia-red-dark text-white font-bold transition flex justify-center items-center shadow-lg hover:shadow-wuxia-red/30 border border-wuxia-gold/30">ç¢ºèªåŠ å…¥</button>
                    </div>
                  </div>
                )}
            </Modal>

            <Modal isOpen={showCart} title="æˆ‘çš„è¡Œå›Š" onClose={() => setShowCart(false)}>
               {cart.length === 0 ? <div className="text-center py-10 text-stone-500">è¡Œå›Šç©ºç©ºå¦‚ä¹Ÿ</div> : (
                  <div className="space-y-4">
                     {cart.map((item, idx) => (
                        <div key={idx} className="bg-black/30 p-3 rounded border border-stone-800 flex flex-col gap-3">
                           <div className="flex justify-between items-start">
                              <div className="flex items-center gap-3"><img src={item.product.imageUrl} className="w-12 h-12 object-cover rounded border border-stone-600"/><div className="flex-1"><p className="text-white text-sm font-bold line-clamp-1">{item.product.name}</p><p className="text-stone-400 text-xs font-mono">${item.product.price} / å–®ä½</p></div></div>
                              <button onClick={() => removeFromCart(item.product.id)} className="text-stone-500 hover:text-red-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                           </div>
                           <div className="flex justify-between items-center pl-[60px]">
                              <div className="flex items-center bg-stone-900 border border-stone-700 rounded h-8"><button onClick={() => updateCartQuantity(item.product.id, -1)} className="w-8 h-full flex items-center justify-center text-stone-400 hover:text-white hover:bg-stone-700 rounded-l transition">-</button><span className="w-10 text-center text-wuxia-gold font-mono font-bold text-sm border-x border-stone-700">{item.quantity}</span><button onClick={() => updateCartQuantity(item.product.id, 1)} className="w-8 h-full flex items-center justify-center text-stone-400 hover:text-white hover:bg-stone-700 rounded-r transition">+</button></div>
                              <span className="text-wuxia-gold font-mono font-bold text-lg">${item.product.price * item.quantity}</span>
                           </div>
                        </div>
                     ))}
                     <div className="border-t border-white/10 pt-4 mt-4 flex justify-between items-end"><span className="text-stone-400">ç¸½é‡‘é¡</span><span className="text-3xl text-wuxia-gold font-mono font-bold">${cartTotal}</span></div>
                     <button onClick={submitOrder} disabled={isProcessing} className="w-full mt-4 py-3 bg-gradient-to-r from-wuxia-red to-wuxia-red-dark text-white rounded font-bold shadow-lg hover:shadow-wuxia-red/30 transition">{isProcessing ? 'è¨‚å–®å»ºç«‹ä¸­...' : 'æäº¤è¨‚å–® (å‰å¾€ä»˜æ¬¾)'}</button>
                  </div>
               )}
            </Modal>

             <Modal isOpen={showBankInfo} title="ä»˜æ¬¾è³‡è¨Š" onClose={() => !isProcessing && setShowBankInfo(false)}>
                  <div className="space-y-6">
                    <div className="text-center bg-wuxia-gold/10 p-3 rounded border border-wuxia-gold/30">
                        <p className="text-wuxia-gold text-xs font-bold">è¨‚å–®å·²æˆç«‹ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾</p>
                        <p className="text-stone-400 text-[10px] mt-1">å–®è™Ÿï¼š{currentOrderId}</p>
                    </div>
                    <p className="text-stone-300 text-sm text-center">è«‹åŒ¯æ¬¾ <span className="text-wuxia-gold font-bold">${cartTotal || currentOrderPrice}</span> è‡³ä»¥ä¸‹å¸³æˆ¶ï¼š</p>
                    <div className="bg-gradient-to-br from-stone-900 to-black p-5 rounded-lg border border-wuxia-gold/50 relative overflow-hidden shadow-inner">
                        <div className="absolute top-0 right-0 p-2 opacity-20 text-6xl text-white font-serif italic font-bold select-none">Bank</div>
                        <div className="relative z-10 space-y-3">
                            <div className="flex justify-between items-end border-b border-white/10 pb-2"><span className="text-stone-400 text-xs">éŠ€è¡Œä»£ç¢¼</span><span className="text-xl font-mono text-white font-bold">{BANK_INFO.code}</span></div>
                            <div className="flex justify-between items-end border-b border-white/10 pb-2"><span className="text-stone-400 text-xs">éŠ€è¡Œåç¨±</span><span className="text-lg text-white font-bold">{BANK_INFO.name}</span></div>
                            <div className="pt-1"><span className="text-stone-400 text-xs block mb-1">åŒ¯æ¬¾å¸³è™Ÿ</span><div className="flex items-center justify-between bg-black/50 p-2 rounded border border-wuxia-gold/20"><span className="text-2xl font-mono text-wuxia-gold tracking-widest">{BANK_INFO.account}</span><button onClick={() => copyToClipboard(BANK_INFO.account)} className="ml-2 px-3 py-1 bg-stone-700 hover:bg-wuxia-gold hover:text-black text-xs text-white rounded transition">è¤‡è£½</button></div></div>
                        </div>
                    </div>
                    <div className="space-y-3 pt-2">
                        <label className="block text-sm text-wuxia-gold font-bold">ä»˜æ¬¾å›å ±</label>
                        <div className="text-xs text-stone-500 mb-1">è«‹è¼¸å…¥æ‚¨è½‰å¸³å¸³è™Ÿçš„å¾Œäº”ç¢¼ï¼Œä»¥ä¾¿ç³»çµ±å°å¸³ã€‚</div>
                        <input type="text" placeholder="è¼¸å…¥å¾Œäº”ç¢¼" value={paymentNote} onChange={(e) => setPaymentNote(e.target.value)} className="w-full bg-black/40 border border-stone-600 rounded p-3 text-white focus:border-wuxia-gold outline-none text-center font-mono tracking-widest text-lg placeholder:text-stone-600 placeholder:text-sm" maxLength={5} />
                    </div>
                    <div className="flex gap-4 mt-4">
                       <button onClick={() => setShowBankInfo(false)} className="px-4 py-3 rounded border border-stone-600 text-stone-400 hover:bg-stone-800 transition text-sm">ç¨å¾Œå›å ±</button>
                       <button type="button" onClick={confirmPaymentInfo} disabled={isProcessing} className={`flex-1 px-4 py-3 rounded bg-gradient-to-r from-wuxia-red to-wuxia-red-dark text-white font-bold transition flex justify-center items-center shadow-lg hover:shadow-wuxia-red/30 border border-wuxia-gold/30 ${isProcessing ? 'opacity-70 cursor-not-allowed' : ''}`}>{isProcessing ? 'æ›´æ–°ä¸­...' : 'å·²åŒ¯æ¬¾ï¼Œé€å‡ºè³‡è¨Š'}</button>
                    </div>
                    <div className="text-center text-[10px] text-stone-600 mt-2">è‹¥æ‚¨ç¾åœ¨ä¸æ–¹ä¾¿ä»˜æ¬¾ï¼Œå¯é—œé–‰æ­¤è¦–çª—ã€‚<br/>æ‚¨çš„è¨‚å–®å·²ä¿ç•™ï¼Œè«‹è¨˜å¾—åœ¨ã€Œç¥¨åˆ¸å¤¾ã€æŸ¥çœ‹ç‹€æ…‹ã€‚</div>
                  </div>
            </Modal>

            <ReportModal 
                isOpen={showReport} 
                user={user} 
                onClose={() => setShowReport(false)} 
                onLogin={loginWithLiffUrl} 
                initialType={reportInitType} 
                products={products} // â˜… Pass Products
            />
            <WalletModal 
                isOpen={showWallet} 
                user={user} 
                onClose={() => setShowWallet(false)} 
                onLogin={loginWithLiffUrl} 
                onOpenAdmin={() => { setShowWallet(false); setShowAdmin(true); }}
                onCancelOrder={handleWalletCancelOrder}
                onReportPayment={handleWalletReportPayment}
            />
            <ProfileModal 
                isOpen={showProfile} 
                user={user} 
                onClose={() => setShowProfile(false)} 
            />
            {showAdmin && <AdminModal isOpen={showAdmin} onClose={() => setShowAdmin(false)} />}
            {showGuide && <GuideModal isOpen={showGuide} onClose={() => setShowGuide(false)} />}
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<React.StrictMode><App /></React.StrictMode>);
      }
    </script>
  </body>
</html>
